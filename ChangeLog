2003-06-25  root  <root@gills.dancysoft.com>

	* Changed the DNS blacklisting to a rcpt-to checker so that sender
	and recipient can be logged.

	* Makefile:  chown installed files to 'root'

	* Update greylist.sql for faster setup.

	* Added greylisting feature.

	* Added rc script for redhat-style hosts.

	* Added DNS-based blacklisting.

	* Added in hooks so that administrators can easily add checks
	during the MAIL FROM and RCPT TO and DATA phases of an SMTP
	session.  The greylisting code uses these.

	* Moved some of the built-in checks that the smtp server did
	during the mail from, rcpt to and data phases into
	smtp-server-checkers.cl.  They use the newly created hooks.

2003-06-23  Ahmon Dancy  <dancy@dancy>

	* utils.cl:  Make short-host-name really return a short host name.

	* config.cl:  Removed franz-specific stuff.

2003-06-18  root  <root@gills.dancysoft.com>

	* Makefile:  Added 'install' rule.

	* deliver.cl:  Downcase local recipient name.

	* load.cl: Don't do the sendmail.dxl and sendmail.lic symlinks
	anymore.  Not necessary w/ new patches.

2003-06-18  Ahmon Dancy  <dancy@dancy>

	* maild.cl: Make use of updated with-command-line-arguments
	patches.  Process -oi option... ignores other unrecognized
	options.  Ignores -bi command line arg.

2003-06-08  root  <root@gills.dancysoft.com>

	* deliver.cl: Add the "From " separator to messages being
	delivered to programs and to files.

	* aliases.cl:  Supports wildcard aliases now.

	* checkers.cl:  Added support for external checker programs.

	* config.cl:  Removed *virtusersfile*.  Not used anymore.  Added
	*external-checker-user* variable for specifying user under which
	external checkers run.

	* deliver-smtp.cl:  Fixed check for nxdomain.

	* deliver.cl:  When delivering to program alias, use
	*program-alias-user*, not *local-delivery-user*.

	* recips.cl:  Fixed buglet.

	* virtusers.cl:  Removed.   Implemented in aliases.

2003-06-06  Ahmon Dancy  <dancy@dancy>

	* config.cl:  New parameter.  *extra-headers-func* for specifying
	the a function that will be called to add additional message
	headers when a queue item is being finalized.

	* emailaddr.cl:  Added unquote-quoted-string.

	* headers.cl:  Don't add the envelope recipient list to the
	Received header.  

	* load.cl:  Added break-on-warnings.

	* queue.cl: Added queue-append-header, queue-replace-header, and
	queue-locate-header convenience functions (intended for use in an
	*extra-headers-func*).
	
	* utils.cl: removed unquote-quoted-string.
	
2003-05-19  root  <root@dancy>

	* config.cl:  Parameterized the blacklisted host message in a new
	*blacklisted-response* variable.  Added a new *maximum-hop-count*
	parameter as well.   Changed *smtp-data-checkers* to
	*message-data-checkers* since they are used during stdin reciption
	and smtp reception.  The default list of checkers is the size
	check and the max hop count check.

	* checkers.cl:  New.  Has hop count and message size checkers.

	* headers.cl:  New count-received-headers function.

	* input.cl:  Run message checks before accepting a message.  Error
	out if we get back reject or transient status.

	* load.cl:  Added "checkers" to the file list.

	* smtp-server.cl:  Use parameterized blacklisted client text now.
	Moved out message checking stuff into check-message-checkers in
	checkers.cl.  


2003-05-16  root  <root@dancy>

	* aliasees.cl:  Always copy recip structs before returning them
	from alias expansions.

	* emailaddr.cl:  Removed parse-email-addr-list.  It has been
	replaced by parse-recip-list in recips.cl   Turned a few parsed
	things into structs for easier manipulation.  Added collect-cfws
	utility function.  Improved "group" mailbox parsing.

	* queue-process.cl:  The list of all queue ids is now sorted
	before being returned.    queue-list:  Print recipient status
	information.  

	* recips.cl:  Rewrote the parse-recip-list stuff again so that it
	can handle group mailboxes but still be flexible when bad
	addresses are encountered during parsing.

	* rewrite.cl:  Fixed up the header rewrite stuff to correspond w/
	the changes in emailaddr.cl

	

2003-05-15  root  <root@gills.dancysoft.com>

	* aliases.cl:  Make sure that only one thread reparses the aliases
	file.   Removed a bunch of stuff that became redundant with the
	new recips code.

	* emailaddr.cl:  Added some extra utility functions (for use in
	recips.cl, mainly).

	* input.cl:  send-from-smtp:  Accept emailaddr or recip struct
	type recips.   use new get-good-recips-from-string function in
	grab-recips-from-headers.  

	* load.cl:  Load recips.cl before aliases.cl.

	* maild.cl:  Added -bv mode for testing address parsing.
	Simplified command line recipient processing by using new
	get-good-recips-from-string function.

	* queue.cl:  queue-finalize:  Accept emailaddr or recip type
	recips.

	* recips.cl:  Added 'orig' slot to recip struct for recording the
	string that was originally parsed.    get-recipient-disposition
	accepts emailaddr or recip struct arg now.   Improved address list
	parsing.  

2003-05-14  Ahmon Dancy  <dancy@dancy>

	* queue.cl:  In queue-finalize, call expand-addresses w/ the queue
	sender so that the address can be removed from mailing lists.

	* recips.cl:  expand-addresses changed so that the message sender
	will be removed from mailing list expansions.  Also fixed up
	same-recip-p.  It behaves in a more sendmail-like way now.


2003-05-12  root  <root@dancy>

	* deliver.cl:  Use new recip struct. 

	* headers.cl:  Removed replace-header function.  It was unsafe
	because it would replace too much if there were multiple headers
	of the same type (for example, two To: headers).  Added
	recip-header-p and sender-header-p utility functions.  

	* input.cl:  Fixed grab-recips-from-headers function so that it
	works for multiple instances of the same header type..

	* queue-process.cl:  Additional recip struct fixes.

	* recips.cl:  Added recip-printable utility function.  

	* rewrite.cl:  Fixed the rewrite-headers function so that it works
	for multiple instances of the same header type.


2003-05-12  root  <root@gills.dancysoft.com>

	* aliases.cl:  Only allow one :error: thing on a right hand side
	of an alias.

	* bounce.cl:  Change the name of the bounce function to 'bounce'.
	Added stuff so that bounces are sent to their proper owners.  Also
	added an additional keyword argument to the bounce function so
	that undeliverable recipients (due to timeout) will have a
	sentence indicating so.

	* config.cl:  Moved the aliases lookup in front of the passwd
	lookup in the *local-recip-checks* parameter.  

	* deliver-smtp.cl:  Uses new recip struct. 

	* emailaddr.cl:  Make sure that the emailaddr-orig for <> is "<>".

	* queue-process.cl:  queue-process-single-help uses the new recip
	struct now.  The function is a smidge simpler now.

	* recips.cl:  Added a 'status' slot to the recip struct.  
	lookup-recip-in-passwd now returns a recip struct.

	get-content-disposition modified since the lookup-recip-in-*
	functions return recip structs now.  expand-recips is now
	expand-addresses.  
	

2003-05-09  root  <root@gills.dancysoft.com>

	* emailaddr.cl:  In parse-email-addr-list.  If cruft is all
	whitespace, then convert it to "".  Also, emailaddr-orig is now
	set to just the user@domain string.  No comments or other stuff is
	included.  

	* headers.cl:  Fixed bug in make-from-header when 'from' is <>.  

	* input.cl:  New function:  grab-recips-from-headers for use w/
	the -t flag.  send-from-stdin now uses this function if it is
	called w/ grab-recips keyword argument.  

	* maild.cl:  Added -t support.

	* queue-process.cl:  Delivery failure messages for a particular
	queue item are collected and sent in a single bounce message now.

	* queue.cl:  make-queue-file doesn't take the recips list now.
	That is saved for the new queue-finalize function (which is mostly
	queue-init-headers renamed).   Updated the with-new-queue macro
	for this as well.

	* several places:  Changes due to the changes in queue.cl.

2003-05-08  root  <root@dancy>

	* aliases.cl:  Aliases file must be owned by root and have safe
	permissions.

	* deliver.cl:  Delivery programs (aliases and defined local
	delivery program) must be owned by root and have safe
	permissions.  I may relax this if it turns out to be too
	restrictive.

	* headers.cl:  Received header now includes the original envelope
	recipients per Charley's request.  Note that this makes Bcc:
	ineffective (in terms of blindness).

	* lock.cl:  Generalized with-lock-file-nowait to with-lock-file
	and a keyword arg.

	* maild.cl:  /etc/maild/cl must be owned by root and have safe
	permissions.  Same w/ *queuedir*.

	* queue.cl:  Queue files are generated in a different way now.
	Simpler.

	* recips.cl:  Moved some of the recipient alias expansion stuff
	out of queue.cl and into this file.   Fixed a bug w/ "user:
	user@localdomain" type expansion.

2003-04-30  root  <root@gills.dancysoft.com>

	* Makefile:  Make maild/maild depend on *.cl

	* bounce.cl: Use new with-new-queue macro.

	* deliver.cl:  Add verbosity to deliver-local function.  In
	send-message-to-program, return stderr along w/ the :transient
	error code if the delivery program exited w/ non-zero
	status... and do the same for the error condition from the message
	stream writer.

	* input.cl:  Had a call to string-downcase in the wrong place.
	Moved.    Updated send-from-stdin.  read-message-stream now calls
	finish-output and fsync on the datafile on behalf of the caller.

	* queue.cl:  Updated with-new-queue macro.

	* smtp-server.cl:  Updated to use with-new-queue macro.  

2003-04-30  root  <root@dancy>

	* deliver.cl:  write-message-to-stream:  headers that spanned
	lines weren't being written out w/ the proper EOL convention.
	Fixed.  

	* queue-process.cl: Rearranged some code in the queue processing
	function for better status reporting.    Minor changes to the
	queue lister.  Added a queue processing daemon.

	* queue.cl:  Added new 'valid' slot to the queue struct.  It is
	used by the new with-new-queue macro.  If the slot is still nil
	when the macro completes, the queue file will be deleted.  This
	effects cleanup for interrupted message transmissions, etc.

	* security.cl:  verify-root: new function to check that the real
	user is root.
	
	* input.cl: send-from-stdin:  Try out new with-new-queue macro.

	* maild.cl: main:  Implemented more of the command line args.  Can
	run in daemon mode now w/ optional periodic queue processing.
	Signal handlers added for SIGINT and SIGTERM for clean shutdown.
	Security checks on queue-manipulating commands.  

	* smtp-server.cl:  New smtp-server-daemon function.

2003-04-28  root  <root@dancy>

	* config.cl: Added *smtp-ip* parameter for binding the server
	socket to a particular interface.

	* smtp-server.cl:  Use the new *smtp-ip* parameter

	* deliver-smtp.cl:  Added :verbose keyword arg to many of the
	functions so that the SMTP transaction can be watched (ala
	sendmail -v).   Also added a with-socket-timeout around the main
	function so that an unresponsive SMTP server doesn't make us hang.

	* deliver.cl:  New write-message-to-stream-async for use with
	send-message-to-program.  It is intended to be called via
	mp:process-run-function.  It takes a structure which has the usual
	arguments to write-message-to-stream.. plus a gate and a status
	field for returning information to the caller.

	* queue-process.cl:  Added :verbose keyword stuff.  Also, the
	queue processor now collects the error messages from the delivery
	subroutines for storage in the queue file.  

2003-04-24  root  <root@dancy>

	* config.cl:  Call local delivery program w/ -f.
	Added comments to the timeouts section.

	* sockets are now hiper sockets so that I can use read and write
	timeouts w/ ease.

	


